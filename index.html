<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>YOLOv7 ONNX Web App</title>
<style>
  body { font-family: sans-serif; background: #1e1e1e; color: #eee; margin:0; padding:0;}
  header, footer { background:#111; color:#eee; padding:10px; text-align:center;}
  main { display:flex; flex-wrap:wrap; gap:20px; padding:20px; justify-content:center;}
  .card { background:#2a2a2a; padding:15px; border-radius:10px; min-width:300px;}
  button,input[type=file],input[type=range],select { margin:5px 0; width:100%;}
  canvas { border:1px solid #555; display:block; margin-top:10px; }
  .slider-label { display:flex; justify-content:space-between; }
</style>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>

<header>
  <h1>YOLOv7 ONNX Web App</h1>
  <p>ブラウザでYOLOv7推論を実行できます</p>
</header>

<main>

<div class="card">
  <h2>モデル & ラベル読み込み</h2>
  <input type="file" id="modelFile" accept=".onnx">
  <input type="file" id="labelFile" accept=".txt">
  <label for="provider">実行プロバイダ:</label>
  <select id="provider">
    <option value="webgl">WebGL</option>
    <option value="webgpu">WebGPU</option>
    <option value="wasm">WASM</option>
  </select>
  <button id="initBtn">モデル初期化</button>
  <p id="status">未初期化</p>
</div>

<div class="card">
  <h2>入力 & プレビュー</h2>
  <input type="file" id="imageFile" accept="image/*">
  <button id="startCam">Webカメラ開始</button>
  <button id="detectBtn" disabled>検出実行</button>
  <canvas id="canvas" width="640" height="480"></canvas>
  <p id="info">検出数: 0</p>
</div>

<div class="card">
  <h2>設定</h2>
  <div class="slider-label"><label>信頼度(conf)</label><span id="confVal">0.25</span></div>
  <input type="range" id="confSlider" min="0" max="1" step="0.01" value="0.25">
  <div class="slider-label"><label>IoU(NMS)</label><span id="iouVal">0.45</span></div>
  <input type="range" id="iouSlider" min="0" max="1" step="0.01" value="0.45">
</div>

</main>

<footer>
  <p>&copy; 2025 YOLOv7 Web App</p>
</footer>

<script>
let session=null;
let labels=[];
let inputImage=null;
let video=null;
let confThreshold=0.25;
let iouThreshold=0.45;

// UI要素
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusEl=document.getElementById("status");
const infoEl=document.getElementById("info");
const detectBtn=document.getElementById("detectBtn");

// スライダー更新
document.getElementById("confSlider").oninput=e=>{confThreshold=parseFloat(e.target.value); document.getElementById("confVal").innerText=confThreshold;}
document.getElementById("iouSlider").oninput=e=>{iouThreshold=parseFloat(e.target.value); document.getElementById("iouVal").innerText=iouThreshold;}

// ラベル読み込み
document.getElementById("labelFile").onchange=async e=>{
  const text=await e.target.files[0].text();
  labels=text.split(/\r?\n/).filter(l=>l);
};

// モデル初期化
document.getElementById("initBtn").onclick=async ()=>{
  const modelFile=document.getElementById("modelFile").files[0];
  if(!modelFile){ alert("モデルを選択してください"); return;}
  statusEl.innerText="初期化中...";
  const provider=document.getElementById("provider").value;
  const options={executionProviders:[provider]};
  session=await ort.InferenceSession.create(await modelFile.arrayBuffer(), options);
  statusEl.innerText="初期化完了";
  detectBtn.disabled=false;
};

// 画像読み込み
document.getElementById("imageFile").onchange=async e=>{
  inputImage=await createImageBitmap(e.target.files[0]);
  drawImage();
};

// Webカメラ開始
document.getElementById("startCam").onclick=async ()=>{
  if(!video){
    video=document.createElement("video");
    video.autoplay=true;
    video.width=640; video.height=480;
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;
    video.onloadedmetadata=()=>{ drawImage(); };
  }
};

// 画像描画
function drawImage(){
  if(video){
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  } else if(inputImage){
    ctx.drawImage(inputImage,0,0,canvas.width,canvas.height);
  }
}

// NMS簡易実装
function nms(boxes,scores,iouThresh){
  let idxs=scores.map((s,i)=>[i,s]).sort((a,b)=>b[1]-a[1]).map(a=>a[0]);
  let keep=[];
  while(idxs.length){
    let i=idxs.shift();
    keep.push(i);
    idxs=idxs.filter(j=>{
      let [x1,y1,w1,h1]=boxes[i];
      let [x2,y2,w2,h2]=boxes[j];
      let xx1=Math.max(x1,x2), yy1=Math.max(y1,y2);
      let xx2=Math.min(x1+w1,x2+w2), yy2=Math.min(y1+h1,y2+h2);
      let w=Math.max(0,xx2-xx1), h=Math.max(0,yy2-yy1);
      let inter=w*h;
      let ovr=inter/((w1*h1)+(w2*h2)-inter);
      return ovr<iouThresh;
    });
  }
  return keep;
}

// 推論
detectBtn.onclick=async ()=>{
  if(!session){ alert("モデル未初期化"); return;}
  drawImage();
  const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=new Float32Array(1*3*canvas.height*canvas.width);
  for(let y=0;y<canvas.height;y++){
    for(let x=0;x<canvas.width;x++){
      const i=(y*canvas.width+x)*4;
      data[y*canvas.width+x]=imageData.data[i]/255.0;
      data[canvas.height*canvas.width+y*canvas.width+x]=imageData.data[i+1]/255.0;
      data[2*canvas.height*canvas.width+y*canvas.width+x]=imageData.data[i+2]/255.0;
    }
  }
  const tensor=new ort.Tensor("float32",[1,3,canvas.height,canvas.width],data);
  const output=await session.run({images:tensor});
  const outArray=output[Object.keys(output)[0]].data;
  const boxes=[], scores=[], classIds=[];
  const n=outArray.length/85;
  for(let i=0;i<n;i++){
    const offset=i*85;
    const conf=outArray[offset+4];
    let maxClass=0, maxScore=0;
    for(let c=0;c<80;c++){
      if(outArray[offset+5+c]>maxScore){ maxScore=outArray[offset+5+c]; maxClass=c; }
    }
    const score=conf*maxScore;
    if(score>confThreshold){
      const cx=outArray[offset], cy=outArray[offset+1];
      const w=outArray[offset+2], h=outArray[offset+3];
      boxes.push([cx-w/2,cy-h/2,w,h]);
      scores.push(score);
      classIds.push(maxClass);
    }
  }
  const keep=nms(boxes,scores,iouThreshold);
  infoEl.innerText="検出数: "+keep.length;
  // 描画
  keep.forEach(i=>{
    const [x,y,w,h]=boxes[i];
    ctx.strokeStyle="red"; ctx.lineWidth=2;
    ctx.strokeRect(x,y,w,h);
    ctx.fillStyle="red"; ctx.font="16px sans-serif";
    ctx.fillText(labels[classIds[i]]+" "+scores[i].toFixed(2),x,y>10?y-5:10);
  });
};
</script>

</body>
</html>
